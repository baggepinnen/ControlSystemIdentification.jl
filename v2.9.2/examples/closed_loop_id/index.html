<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Identification in closed loop · ControlSystemIdentification Documentation</title><meta name="title" content="Identification in closed loop · ControlSystemIdentification Documentation"/><meta property="og:title" content="Identification in closed loop · ControlSystemIdentification Documentation"/><meta property="twitter:title" content="Identification in closed loop · ControlSystemIdentification Documentation"/><meta name="description" content="Documentation for ControlSystemIdentification Documentation."/><meta property="og:description" content="Documentation for ControlSystemIdentification Documentation."/><meta property="twitter:description" content="Documentation for ControlSystemIdentification Documentation."/><script data-outdated-warner src="../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../search_index.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../../">ControlSystemIdentification Documentation</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../../">Home</a></li><li><a class="tocitem" href="../../iddata/">Identification data</a></li><li><a class="tocitem" href="../../ss/">State-space estimation</a></li><li><a class="tocitem" href="../../tf/">Transfer-function estimation</a></li><li><a class="tocitem" href="../../impulse/">Impulse-response estimation</a></li><li><a class="tocitem" href="../../freq/">Frequency-domain estimation</a></li><li><a class="tocitem" href="../../validation/">Validation</a></li><li><a class="tocitem" href="../../nonlinear/">Nonlinear identification</a></li><li><span class="tocitem">Examples</span><ul><li><a class="tocitem" href="../temp/">Temperature control</a></li><li class="is-active"><a class="tocitem" href>Identification in closed loop</a><ul class="internal"><li><a class="tocitem" href="#Detecting-the-presence-of-feedback"><span>Detecting the presence of feedback</span></a></li></ul></li><li><a class="tocitem" href="../unstable_systems/">Identification of unstable systems</a></li><li><a class="tocitem" href="../delayest/">Delay estimation</a></li><li><a class="tocitem" href="../ballandbeam/">Ball and beam</a></li><li><a class="tocitem" href="../flexible_robot/">Flexible robot arm</a></li><li><a class="tocitem" href="../glass_furnace/">Glass furnace</a></li><li><a class="tocitem" href="../evaporator/">Evaporator</a></li><li><a class="tocitem" href="../hair_dryer/">Hair dryer</a></li><li><a class="tocitem" href="../varx/">VARX model</a></li><li><a class="tocitem" href="../hammerstein_wiener/">Nonlinear belt drive</a></li></ul></li><li><a class="tocitem" href="../../api/">API</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Examples</a></li><li class="is-active"><a href>Identification in closed loop</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Identification in closed loop</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/baggepinnen/ControlSystemIdentification.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/baggepinnen/ControlSystemIdentification.jl/blob/master/docs/src/examples/closed_loop_id.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Closed-loop-identification"><a class="docs-heading-anchor" href="#Closed-loop-identification">Closed-loop identification</a><a id="Closed-loop-identification-1"></a><a class="docs-heading-anchor-permalink" href="#Closed-loop-identification" title="Permalink"></a></h1><p>This example will investigate how different identification algorithms perform on closed-loop data, i.e., when the input to the system is produced by a controller using output feedback.</p><p>We will consider a very simple system <span>$G(z) = \dfrac{1}{z - 0.9}$</span> with colored output noise and various inputs formed by output feedback <span>$u = -Ly + r(t)$</span>, where <span>$r$</span> will vary between the experiments.</p><p>It is well known that in the absence of <span>$r$</span> and with a simple regulator, identifiability is poor, indeed, if</p><p class="math-container">\[y_{k+1} = a y_k + b u_k, \quad u_k = L y_k\]</p><p>we get the closed-loop system</p><p class="math-container">\[y_{k+1} = (a + bL)y_k\]</p><p>where we can not distinguish <span>$a$</span> and <span>$b$</span>. The introduction of <span>$r$</span> resolves this</p><p class="math-container">\[\begin{aligned}
y_{k+1} &amp;= a y_k + b u_k \\
u_k &amp;= L y_k + r \\
y_{k+1} &amp;= (a + bL)y_k + b r_k
\end{aligned}\]</p><p>The very first experiment below will illustrate the problem when there is no excitation through <span>$r$</span>.</p><p>We start by defining a model of the true system, a function that simulates some data and adds colored output noise, as well as a function that estimates three different models and plots their frequency responses. We will consider three estimation methods</p><ol><li><a href="../../tf/#ControlSystemIdentification.arx"><code>arx</code></a>, a prediction-error approach based on a least-squares estimate.</li><li>A subspace-based method <a href="../../ss/#ControlSystemIdentification.subspaceid"><code>subspaceid</code></a>, known to be biased in the presence of output feedback.</li><li>The prediction-error method (PEM) <a href="../../ss/#ControlSystemIdentification.newpem"><code>newpem</code></a></li></ol><p>The ARX and PEM methods are theoretically unbiased in the presence of output feedback, see <sup class="footnote-reference"><a id="citeref-Ljung" href="#footnote-Ljung">[Ljung]</a></sup>, while the subspace-based method is not. (Note: the subspace-based method is used to form the initial guess for the iterative PEM algorithm)</p><pre><code class="language-julia hljs">using ControlSystemsBase, ControlSystemIdentification, Plots
G = tf(1, [1, -0.9], 1) # True system

function generate_data(u; T)
    E = c2d(tf(1 / 100, [1, 0.01, 0.1]), 1) # Noise model for colored noise
    e = lsim(E, randn(1, T)).y              # Noise realization
    function u_noise(x, t)
        y = x .+ e[t] # Add the measured noise to the state to simulate feedback of measurement noise
        u(y, t)
    end
    res = lsim(G, u_noise, 1:T, x0 = [1])
    d = iddata(res)
    d.y .+= e # Add the measurement noise to the output that is stored in the data object
    d
end

function estimate_and_plot(d, nx=1; title, focus=:prediciton)
    Gh1 = arx(d, 1, 1)

    sys0 = subspaceid(d, nx; focus)
    tf(sys0)

    Gh2, _ = ControlSystemIdentification.newpem(d, nx; sys0, focus)
    tf(Gh2)

    figb = bodeplot(
        [G, Gh1, sys0.sys, Gh2.sys];
        ticks = :default,
        title,
        lab = [&quot;True system&quot; &quot;ARX&quot; &quot;Subspace&quot; &quot;PEM&quot;],
        plotphase = false,
    )

    figd = plot(d)
    plot(figb, figd)
end</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">estimate_and_plot (generic function with 2 methods)</code></pre><p>In the first experiment, we have <strong>no reference excitation</strong>, with a small amount of data (<span>$T=80$</span>), we get terrible estimates</p><pre><code class="language-julia hljs">L = 0.5 # Feedback gain u = -L*x
u = (x, t) -&gt; -L * x
title = &quot;-Lx&quot;
estimate_and_plot(generate_data(u, T=80), title=title*&quot;,  T=80&quot;)</code></pre><img src="92c54d9f.svg" alt="Example block output"/><p>with a larger amount of data <span>$T=8000$</span>, we get equally terrible estimates</p><pre><code class="language-julia hljs">estimate_and_plot(generate_data(u, T=8000), title=title*&quot;,  T=8000&quot;)</code></pre><img src="bd2f238d.svg" alt="Example block output"/><p>This indicates that we can not hope to estimate a model if the system is driven by noise only.</p><p>We now consider a simple, <strong>periodic excitation</strong> <span>$r = \sin(t)$</span></p><pre><code class="language-julia hljs">L = 0.5 # Feedback gain u = -L*x
u = (x, t) -&gt; -L * x .+ 5sin(t)
title = &quot;-Lx + 5sin(t)&quot;
estimate_and_plot(generate_data(u, T=80), title=title*&quot;,  T=80&quot;)</code></pre><img src="916e5a0e.svg" alt="Example block output"/><p>In this case, all but the subspace-based method performs quite well</p><pre><code class="language-julia hljs">estimate_and_plot(generate_data(u, T=8000), title=title*&quot;,  T=8000&quot;)</code></pre><img src="55d218fd.svg" alt="Example block output"/><p>More data does not help the subspace method.</p><p>With <strong>a more complex excitation</strong> (random white-spectrum noise), all methods perform well</p><pre><code class="language-julia hljs">L = 0.5 # Feedback gain u = -L*x
u = (x, t) -&gt; -L * x .+ 5randn()
title = &quot;-Lx + 5randn()&quot;
estimate_and_plot(generate_data(u, T=80), title=title*&quot;,  T=80&quot;)</code></pre><img src="436f042e.svg" alt="Example block output"/><p>and even slightly better with more data.</p><pre><code class="language-julia hljs">estimate_and_plot(generate_data(u, T=8000), title=title*&quot;,  T=8000&quot;)</code></pre><img src="68a6eebb.svg" alt="Example block output"/><p>If the <strong>feedback is strong but the excitation is weak</strong>, the results are rather poor for all methods, it&#39;s thus important to have enough energy in the excitation compared to the feedback path.</p><pre><code class="language-julia hljs">L = 1 # Feedback gain u = -L*x
u = (x, t) -&gt; -L * x .+ 0.1randn()
title = &quot;-Lx + 0.1randn()&quot;
estimate_and_plot(generate_data(u, T=80), title=title*&quot;,  T=80&quot;)</code></pre><img src="43c2e82c.svg" alt="Example block output"/><p>In this case, we can try to increase the model order of the PEM and subspace-based methods to see if they are able to learn the noise model (which has two poles)</p><pre><code class="language-julia hljs">estimate_and_plot(generate_data(u, T=8000), 3, title=title*&quot;,  T=8000&quot;)</code></pre><img src="a8ee43ad.svg" alt="Example block output"/><p>learning the noise model can sometimes work reasonably well, but requires more data. You may extract the learned noise model using <a href="../../ss/#ControlSystemIdentification.noise_model"><code>noise_model</code></a>.</p><h2 id="Detecting-the-presence-of-feedback"><a class="docs-heading-anchor" href="#Detecting-the-presence-of-feedback">Detecting the presence of feedback</a><a id="Detecting-the-presence-of-feedback-1"></a><a class="docs-heading-anchor-permalink" href="#Detecting-the-presence-of-feedback" title="Permalink"></a></h2><p>It is sometimes possible to detect the presence of feedback in a dataset by looking at the cross-correlation between input and output. For a causal system, there shouldn&#39;t be any correlation for negative lags, but feedback literally feeds outputs back to the input, leading to a reverse causality:</p><pre><code class="language-julia hljs">L = 0.5 # Feedback gain u = -L*x
u = (x, t) -&gt; -L * x .+ randn.()
title = &quot;-Lx + 5sin(t)&quot;
crosscorplot(generate_data(u, T=500), -5:10, m=:circle)</code></pre><img src="ac646ada.svg" alt="Example block output"/><p>Here, the plot clearly has significant correlation for both positive and negative lag, indicating the presence of feedback. The controller used here is a static P-controller, leading to a one-step correlation backwards in time. With a dynamic contorller (like a PI controller), the effect would be more significant.</p><p>If we remove the feedback, we get</p><pre><code class="language-julia hljs">L = 0.0 # no feedback
u = (x, t) -&gt; -L * x .+ randn.()
title = &quot;-Lx + 5sin(t)&quot;
crosscorplot(generate_data(u, T=500), -5:10, m=:circle)</code></pre><img src="c9f99862.svg" alt="Example block output"/><p>now, the correlation for negative lags and zero lag is mostly non-significant (below the dashed lines).</p><section class="footnotes is-size-7"><ul><li class="footnote" id="footnote-Ljung"><a class="tag is-link" href="#citeref-Ljung">Ljung</a>Ljung, Lennart. &quot;System identification–-Theory for the user&quot;, Ch 13.</li></ul></section></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../temp/">« Temperature control</a><a class="docs-footer-nextpage" href="../unstable_systems/">Identification of unstable systems »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="auto">Automatic (OS)</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.0.1 on <span class="colophon-date" title="Wednesday 20 September 2023 06:53">Wednesday 20 September 2023</span>. Using Julia version 1.9.3.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
